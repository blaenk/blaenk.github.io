<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Clojure Web Development - Blaenk Denum</title>
  <meta name="author" content="Jorge Israel Peña">
  <meta name="description" content="AKA Blaenk Denum">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="/favicon.png" rel="shortcut icon">
  <link href='http://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Merriweather:900italic,900,700italic,400italic,700,400,300italic,300' rel='stylesheet' type='text/css'>
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='/css/screen.css' rel='stylesheet' type='text/css' media='screen' />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml" />
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured"></script>
  <script src="https://rawgit.com/ekalinin/typogr.js/master/typogr.min.js"></script>
  <script src='/js/blaenk.js' type='text/javascript'></script>
</head>
<body>
  <div class="page-wrapper">
    <header id="header">
  <div id="stamp">
    <h1 id="name">
      <a href="/">
        <span class="emboldened">Jorge</span>.Israel.<span class="emboldened">Peña</span>
      </a>
    </h1>
    <h4 id="pseudonym">
      AKA <span class="emboldened">Blaenk</span>.Denum
    </h4>
  </div>
  <nav id="main-nav">
    <ul class="main">
      <li><a href="/about/">About</a></li>
      <li><a href="/notes/">Notes</a></li>
      <li><a href="/work/">Work</a></li>
      <li><a href="/lately/">Lately</a></li>
      <li><a id="search_btn">Search</a></li>
    </ul>
  </nav>
  <nav id="mobile-nav">
    <div class="menu">
      <a class="button">Menu</a>
      <div class="container">
        <ul class="main">
          <li><a href="/about/">About</a></li>
          <li><a href="/notes/">Notes</a></li>
          <li><a href="/work/">Work</a></li>
          <li><a href="/lately/">Lately</a></li>
        </ul>
      </div>
    </div>
    <div class="search">
      <a class="button"></a>
      <div class="container">
        <form action="http://google.com/search" method="get">
          <input type="text" name="q" results="0">
          <input type="hidden" name="q" value="site:blaenkdenum.com">
        </form>
      </div>
    </div>
  </nav>
</header>
<form class="desk_search" action="http://google.com/search" method="get">
  <input id="search" type="text" name="q" results="0" placeholder="Search" autocomplete="off" spellcheck="false">
  <input type="hidden" name="q" value="site:blaenkdenum.com">
</form>

    
        <article class="post">
  <h2 class="title"><a href="/notes/clojure-web-development"><span>Clojure Web Development</span></a></h2>
  <div class="entry-content"><p>I&#39;ve noticed a lot of very interesting ideas coming out of the Clojure web development environment lately, so I decided to explore this space after <a href="/notes/clojure/">learning about Clojure</a>.</p>

<p>On the server-side, Clojure seems to favor basic libraries to build up applications instead of monolithic, opinionated web frameworks <sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>. The <a href="https://github.com/cgrand/enlive">Enlive</a> server-side templating library introduces a novel idea of transforming pure HTML for the purpose of dynamically generating content, instead of embedding a language within HTML as has been tradition.</p>

<p>On the client-side, there&#39;s the venerable <a href="https://github.com/clojure/clojurescript/">ClojureScript</a> which I consider to be a more appealing JavaScript-based language than the existing ones (e.g. CoffeeScript). This has become a powerful technology to use alongside <a href="https://github.com/swannodette/om">Om</a>, which provides a ClojureScript interface to <a href="/notes/react/">React</a>, and leverages persistent, immutable datastructures for <a href="http://swannodette.github.io/2013/12/17/the-future-of-javascript-mvcs/">remarkable performance increases</a>.</p>

<nav id="toc">
<h3>Contents</h3><ol>
<li>
<a href="#architecture">Architecture</a>
</li>
<li>
<a href="#handling">Handling</a>
</li>
<li>
<a href="#routing">Routing</a>
</li>
<li>
<a href="#resources">Resources</a>
</li>
<li>
<a href="#templating">Templating</a>
<ol>
<li>
<a href="#hiccup">Hiccup</a>
</li>
<li>
<a href="#enlive">Enlive</a>
</li>
</ol>
</li>
<li>
<a href="#databases">Databases</a>
<ol>
<li>
<a href="#jdbc">JDBC</a>
</li>
<li>
<a href="#korma">Korma</a>
</li>
</ol>
</li>
<li>
<a href="#clojurescript">ClojureScript</a>
<ol>
<li>
<a href="#building">Building</a>
</li>
</ol>
</li>
<li>
<a href="#om">Om</a>
</li>
<li>
<a href="#deployment">Deployment</a>
<ol>
<li>
<a href="#http-kit">HTTP Kit</a>
</li>
</ol>
</li>
</ol>
</nav>
<h1 id="architecture">
<span class="hash">#</span>
<a href="#architecture" class="header-link">Architecture</a>
</h1>
<p>A general architecture can be one where handlers, routes, models, and views are split off into their own namespaces. Routes relating to specific workflows would be defined in their own namespaces where that behavior is defined. The routes can then be combined into a single handler using Compojure&#39;s <code>routes</code> macro.</p>

<p>The <span class="path">project.clj</span> file should contain the <code>:ring</code> declaration which defines the application handler and, optionally, functions to run on application startup and shutdown.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="ss">:ring</span> <span class="p">{</span><span class="ss">:handler</span> <span class="nv">guestbook.handler/app</span>
       <span class="ss">:init</span>    <span class="nv">guestbook.handler/init</span>
       <span class="ss">:destroy</span> <span class="nv">guestbook.handler/destroy</span><span class="p">}</span>
</code></pre></figure><h1 id="handling">
<span class="hash">#</span>
<a href="#handling" class="header-link">Handling</a>
</h1>
<p><a href="https://github.com/ring-clojure/ring">Ring</a> is the most popular, lowest-level library for developing web applications. It consists of four components: handlers, requests, responses, and middleware.</p>

<p>Requests and responses are represented as standard Clojure maps. Handlers are functions that process incoming requests, taking request maps and returning response maps. The following response outputs the visitor&#39;s IP address.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">handler</span> <span class="p">[</span><span class="nv">request-map</span><span class="p">]</span>
  <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span>
   <span class="ss">:headers</span> <span class="p">{</span><span class="s">&quot;Content-Type&quot;</span> <span class="s">&quot;text/html&quot;</span><span class="p">}</span>
   <span class="ss">:body</span> <span class="p">(</span><span class="nb">str </span><span class="s">&quot;ip is &quot;</span> <span class="p">(</span><span class="ss">:remote-addr</span> <span class="nv">request-map</span><span class="p">))})</span>
</code></pre></figure>
<p>Middleware can wrap handlers to modify the way the request is processed, or more specifically, a function that accepts an existing handler and returns a new handler with added behavior---a closure. The following adds a <code>Pragma</code> value to the response headers.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">wrap-nocache</span> <span class="p">[</span><span class="nv">handler</span><span class="p">]</span>
  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">request</span><span class="p">]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">response</span> <span class="p">(</span><span class="nf">handler</span> <span class="nv">request</span><span class="p">)]</span>
      <span class="p">(</span><span class="nf">assoc-in</span> <span class="nv">response</span> <span class="p">[</span><span class="ss">:headers</span> <span class="s">&quot;Pragma&quot;</span><span class="p">]</span> <span class="s">&quot;no-cache&quot;</span><span class="p">))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">app</span> <span class="p">(</span><span class="nf">wrap-nocache</span> <span class="nv">handler</span><span class="p">))</span>
</code></pre></figure>
<p>A decent middleware combination to use for a typical site is <span class="path">compojure.handler/site</span>, which includes support for sessions, cookies, flash, and parameter destructuring.</p>

<p>The <a href="https://github.com/noir-clojure/lib-noir">lib-noir</a> library contains a variety of middleware, such as session and cookie handling, redirects, input validation, password hashing, and so on. Each middleware can wrap a previously defined application handler.</p>

<p>Redirection is possible via <span class="path">ring.util.response/redirect</span> which comes with Ring, however, lib-noir also has such a function as <span class="path">noir.response/redirect</span>, which accepts an optional status code to supply. Both functions take a path---relative to the root---to which to redirect.</p>

<p>Session management is also provided by the <span class="path">noir.session</span> namespace. The session store is handled by Ring, and a type of store must be specified, such as <span class="path">ring.middleware.session.memory</span>, though there are other available back-ends for the session, such as Redis. The following session management functions are available:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Function</th>
<th style="text-align: left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>clear!</code></td>
<td style="text-align: left">clear entire session</td>
</tr>
<tr>
<td style="text-align: left"><code>flash-put</code></td>
<td style="text-align: left">store flash value</td>
</tr>
<tr>
<td style="text-align: left"><code>flash-get</code></td>
<td style="text-align: left">get flash value</td>
</tr>
<tr>
<td style="text-align: left"><code>get</code></td>
<td style="text-align: left">get session value</td>
</tr>
<tr>
<td style="text-align: left"><code>put!</code></td>
<td style="text-align: left">set session value</td>
</tr>
<tr>
<td style="text-align: left"><code>remove!</code></td>
<td style="text-align: left">remove session value</td>
</tr>
</tbody>
</table>

<p>Input validation is provided by <span class="path">noir.validation</span>. Validation is performed by specifying a set of rules for a handler using the <code>rule</code> function, which accepts a condition that must be satisfied, and a vector consisting of a field name as a keyword and an error to associate with it in the event that the condition is not satisfied. The <code>errors?</code> function is then used to see if there were any unsatisfied validations, in order to provide an alternative response, for example.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">handle-login</span> <span class="p">[</span><span class="nv">id</span> <span class="nv">pass</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">has-value?</span> <span class="nv">id</span><span class="p">)</span>
    <span class="p">[</span><span class="ss">:id</span> <span class="s">&quot;name required&quot;</span><span class="p">])</span>
  <span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nb">= </span><span class="nv">id</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
    <span class="p">[</span><span class="ss">:id</span> <span class="s">&quot;name must be &#39;foo&#39;&quot;</span><span class="p">])</span>
  
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">errors?</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">error-response</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">normal-response</span><span class="p">)))</span>
</code></pre></figure>
<p>The <code>on-error</code> function can be used to format the error messages, if there are any. It takes as first argument the field name as a keyword and as second argument a function which gets passed the errors, and it returns that function&#39;s result.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">login-page</span> <span class="p">[]</span>
  <span class="p">(</span><span class="nf">layout/common</span>
    <span class="p">(</span><span class="nf">on-error</span> <span class="ss">:id</span>
      <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">errors</span><span class="p">]</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">errors</span><span class="p">)))))</span>
</code></pre></figure>
<p>Hashing is exposed via <span class="path">noir.util.crypt</span>, particularly functions <code>compare</code> and <code>encrypt</code>.</p>

<p>There are helper functions for specifying content-type in <span class="path">noir.response</span>. The <code>content-type</code> function can take a MIME type and the response. There is also a <code>json</code> function that can automatically serialize a data structure passed to it.</p>

<p>It&#39;s possible to specify access rules for a group of paths by using <span class="path">noir.util.middleware/wrap-access-rules</span> to wrap the access rules around the application handler.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">user-access</span> <span class="p">[</span><span class="nv">req</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">session/get</span> <span class="ss">:user</span><span class="p">))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">app</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">routes</span> <span class="nv">private-pages</span> <span class="nv">app-routes</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">middleware/app-handler</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">middleware/wrap-access-rules</span>
      <span class="p">[{</span><span class="ss">:uri</span> <span class="s">&quot;/admin/*&quot;</span> <span class="ss">:rule</span> <span class="nv">admin-access</span>
        <span class="ss">:uri</span> <span class="s">&quot;/user/*&quot;</span> <span class="ss">:rules</span> <span class="p">{</span><span class="ss">:any</span> <span class="p">[</span><span class="nv">user-access</span> <span class="nv">admin-access</span><span class="p">]}}])))</span>
</code></pre></figure>
<p>A route should be wrapped with the <code>restricted</code> macro to express that it should be subject to access rules. The <code>def-restricted-routes</code> macro can be used to implicitly wrap a set of routes with <code>restricted</code> and give them a name.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">def-restricted-routes</span> <span class="nv">private-pages</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/profile&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">show-profile</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/my-secret-page&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">show-secret-page</span><span class="p">)))</span>
</code></pre></figure><h1 id="routing">
<span class="hash">#</span>
<a href="#routing" class="header-link">Routing</a>
</h1>
<p>Routes can be defined using <a href="https://github.com/weavejester/compojure">Compojure</a>, effectively allowing handler functions to be associated with a URL and HTTP method.</p>

<p>A typical route declaration takes the HTTP method name (or <code>ANY</code> to match any method), the URI pattern to match, the list of parameters to pass on to the handler function, and the expression to use as the response. The <code>routes</code> function can be used to group multiple routes together into a single handler. In fact, the <code>defroutes</code> macro can also be used to generate a named handler.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">foo-handler</span> <span class="p">[]</span> <span class="s">&quot;foo called&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">bar-handler</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nb">str </span><span class="s">&quot;bar called with id &quot;</span> <span class="nv">id</span><span class="p">))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">handler</span>
  <span class="p">(</span><span class="nf">routes</span>
    <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/foo&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">foo-handler</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/bar/:id&quot;</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">bar-handler</span> <span class="nv">id</span><span class="p">))))</span>

<span class="c1">; or</span>
<span class="p">(</span><span class="nf">defroutes</span> <span class="nv">handler</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/foo&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">foo-handler</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/bar/:id&quot;</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">bar-handler</span> <span class="nv">id</span><span class="p">)))</span>
</code></pre></figure>
<p>The <code>context</code> macro can be used to specify routes with a common prefix, with the ability to capture any possible variables expressed in the prefix.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="c1">; routes for</span>
<span class="c1">; /user/:id/profile</span>
<span class="c1">; /user/:id/settings</span>
<span class="c1">; /user/:id/change-password</span>

<span class="p">(</span><span class="k">def </span><span class="nv">user-routes</span>
  <span class="p">(</span><span class="nf">context</span> <span class="s">&quot;/usr/:id&quot;</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/profile&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">display-profile</span> <span class="nv">id</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/settings&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">display-settings</span> <span class="nv">id</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/change-password&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">change-password-page</span> <span class="nv">id</span><span class="p">))))</span>
</code></pre></figure>
<p>A symbol can instead be provided as the second argument in a route to bind the request map to that symbol within the context of the handler, as well as a destructured form to only bind certain keys.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">((</span><span class="nf">PUT</span> <span class="s">&quot;/:id&quot;</span> <span class="nv">req</span> <span class="p">(</span><span class="nb">str </span><span class="s">&quot;Requested &quot;</span> <span class="p">(</span><span class="ss">:uri</span> <span class="nv">req</span><span class="p">)))</span> <span class="p">{</span><span class="ss">:uri</span> <span class="s">&quot;/foo&quot;</span><span class="p">})</span>
<span class="p">((</span><span class="nf">PUT</span> <span class="s">&quot;/:id&quot;</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">uri</span><span class="p">]}</span> <span class="p">(</span><span class="nb">str </span><span class="s">&quot;Requested &quot;</span> <span class="nv">uri</span><span class="p">)))</span>
</code></pre></figure>
<p>Form parameters are also accessible by name in the parameter list. It&#39;s also possible to bind a subset of the parameters and bind the rest to a map, or bind the whole parameter to a map.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">POST</span> <span class="s">&quot;/&quot;</span> <span class="p">[</span><span class="nb">name </span><span class="nv">message</span><span class="p">]</span> <span class="p">(</span><span class="nf">save-message</span> <span class="nb">name </span><span class="nv">message</span><span class="p">))</span>
<span class="p">(</span><span class="nf">POST</span> <span class="s">&quot;/&quot;</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span> <span class="o">&amp;</span> <span class="nv">z</span><span class="p">]</span> <span class="nv">...</span><span class="p">)</span>   <span class="c1">; z is map containing remaining parameters</span>
<span class="p">(</span><span class="nf">POST</span> <span class="s">&quot;/&quot;</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span> <span class="ss">:as</span> <span class="nv">r</span><span class="p">]</span> <span class="nv">...</span><span class="p">)</span> <span class="c1">; r is complete request map</span>
</code></pre></figure>
<p>There are special route matchers for static resources and catch-all routes.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app-routes</span>
  <span class="p">(</span><span class="nf">route/resources</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">route/not-found</span> <span class="s">&quot;Not found&quot;</span><span class="p">))</span>
</code></pre></figure><h1 id="resources">
<span class="hash">#</span>
<a href="#resources" class="header-link">Resources</a>
</h1>
<p>The <a href="http://clojure-liberator.github.io/liberator/">Liberator</a> library can simplify the creation of RESTful services by providing macros for defining service resources.</p>

<p>The <code>resource</code> macro can be used to define an anonymous resource, whereas the <code>defresource</code> macro can define a named resource. Both evaluate to a Ring handler which can then be passed to a Compojure route definition.</p>

<p>The Compojure route must use <code>ANY</code> as its method pattern to delegate the match to the resource definition.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">home-routes</span>
  <span class="p">(</span><span class="nf">ANY</span> <span class="s">&quot;/&quot;</span> <span class="nv">request</span>
    <span class="p">(</span><span class="nf">resource</span>
      <span class="ss">:handle-ok</span> <span class="s">&quot;Works&quot;</span>
      <span class="ss">:available-media-types</span> <span class="p">[</span><span class="s">&quot;text/plain&quot;</span><span class="p">])))</span>

<span class="c1">; or</span>
<span class="p">(</span><span class="nf">defresource</span> <span class="nv">home</span>
  <span class="ss">:handle-ok</span> <span class="s">&quot;Works&quot;</span>
  <span class="ss">:available-media-types</span> <span class="p">[</span><span class="s">&quot;text/plain&quot;</span><span class="p">])</span>

<span class="p">(</span><span class="nf">defroutes</span> <span class="nv">home-routes</span>
  <span class="p">(</span><span class="nf">ANY</span> <span class="s">&quot;/&quot;</span> <span class="nv">request</span> <span class="nv">home</span><span class="p">))</span>
</code></pre></figure>
<p>Resource definitions consist of maps with keys that are either a decision, handler, action, or declaration. The values of these keys are constants or functions, where the functions take the <em>context</em> as their single argument. The context is a map containing keys for the request, resource, and optionally the representation---the result of content negotiation.</p>

<p>Decisions determine how to handle a request Their keys end in a question mark <code>?</code>, and their values must evaluate to a boolean value. If a function is used, the following return values are legal:</p>

<ol>
<li>a <strong>boolean</strong> indicating the result of the decision</li>
<li>a <strong>map</strong> which is interpreted as having returned <code>true</code> and merges the map into the response map</li>
<li>a <strong>vector</strong> with first element being the outcome boolean and second element being the map to merge into the response map</li>
</ol>

<p>If a decision is unsatisfied (i.e. evaluates to false), the corresponding error code is returned. For example, if <code>:service-available?</code> evaluated to false, it would return HTTP 503 Service not available.</p>

<p>Another decision that can be used is <code>:method-allowed?</code> which determines whether the HTTP request method is allowed. There is also the <code>:allowed-methods</code> key which takes a vector of methods as keywords.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">defresource</span> <span class="nv">home</span>
  <span class="ss">:method-allowed?</span>
  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">context</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">= </span><span class="ss">:get</span> <span class="p">(</span><span class="nf">get-in</span> <span class="nv">context</span> <span class="p">[</span><span class="ss">:request</span> <span class="ss">:request-method</span><span class="p">]))))</span>

<span class="c1">; or</span>
<span class="p">(</span><span class="nf">defresource</span> <span class="nv">home</span>
  <span class="ss">:allowed-methods</span> <span class="p">[</span><span class="ss">:get</span><span class="p">])</span>
</code></pre></figure>
<p>Handlers are keys prefixed by <code>:handle-</code>, followed by the <a href="http://clojure-liberator.github.io/liberator/doc/handlers.html">name of an HTTP response</a>. These are usually paired with decisions.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">defresource</span> <span class="nv">home</span>
  <span class="ss">:method-allowed?</span> <span class="p">(</span><span class="nf">request-method-in</span> <span class="ss">:get</span><span class="p">)</span>
  <span class="ss">:handle-method-not-allowed</span>
  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">context</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nf">get-in</span> <span class="nv">context</span> <span class="p">[</span><span class="ss">:request</span> <span class="ss">:request-method</span><span class="p">])</span> <span class="s">&quot; is not allowed&quot;</span><span class="p">)))</span>
</code></pre></figure>
<p>Actions exist for HTTP request methods PUT, POST, and DELETE, and they have a question mark suffix <code>!</code> to denote that they are mutating the application&#39;s internal state. When an action occurs, a result can be returned using <code>:handle-created</code>.</p>

<p>Declarations indicate the resource&#39;s capabilities, such as <code>:available-media-types</code> which specifies the MIME types that the resource can be returned as, or <code>:etag</code> for caching.</p>

<p>The <a href="https://github.com/dakrone/cheshire">Chesire</a> library is used for fast and easy JSON parsing and generating.</p>
<h1 id="templating">
<span class="hash">#</span>
<a href="#templating" class="header-link">Templating</a>
</h1>
<p>There are two popular solutions for templating in Clojure. One represents HTML elements as vectors and the other transforms pure HTML.</p>
<h2 id="hiccup">
<span class="hash">#</span>
<a href="#hiccup" class="header-link">Hiccup</a>
</h2>
<p><a href="https://github.com/weavejester/hiccup">Hiccup</a> represents HTML elements as vectors with optional maps of attributes. The <code>html</code> macro is used to generate the resulting HTML string from the Hiccup vectors. Setting id and classes can be done on the keyword itself.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">html</span> <span class="p">[</span><span class="ss">:div</span> <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;hello&quot;</span>, <span class="ss">:class</span> <span class="s">&quot;content&quot;</span><span class="p">}</span>
        <span class="p">[</span><span class="ss">:p</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">]])</span>
<span class="c1">;= &lt;div id=&quot;hello&quot; class=&quot;content&quot;&gt;&lt;p&gt;Hello world!&lt;/p&gt;&lt;/div&gt;</span>

<span class="p">(</span><span class="nf">html</span> <span class="p">[</span><span class="ss">:div#hello.content</span> <span class="p">[</span><span class="ss">:p</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">]])</span>
<span class="c1">;= &lt;div id=&quot;hello&quot; class=&quot;content&quot;&gt;&lt;p&gt;Hello world!&lt;/p&gt;&lt;/div&gt;</span>
</code></pre></figure>
<p>There are helper functions that can generate HTML elements, and these can always take an optional map of attributes.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">link-to</span> <span class="p">{</span><span class="ss">:align</span> <span class="s">&quot;left&quot;</span><span class="p">}</span> <span class="s">&quot;http://google.com&quot;</span> <span class="s">&quot;google&quot;</span><span class="p">)</span>
<span class="c1">;= [:a {:align &quot;left&quot;, :href #&lt;URI http://google.com&gt;} (&quot;google&quot;)]</span>

<span class="p">(</span><span class="nf">form-to</span> <span class="p">[</span><span class="ss">:post</span> <span class="s">&quot;/&quot;</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:p</span> <span class="s">&quot;Name: &quot;</span> <span class="p">(</span><span class="nf">text-field</span> <span class="s">&quot;name&quot;</span><span class="p">)]</span>
  <span class="p">[</span><span class="ss">:p</span> <span class="s">&quot;Message: &quot;</span> <span class="p">(</span><span class="nf">text-area</span> <span class="p">{</span><span class="ss">:rows</span> <span class="mi">10</span> <span class="ss">:cols</span> <span class="mi">40</span><span class="p">}</span> <span class="s">&quot;message&quot;</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">submit-button</span> <span class="s">&quot;comment&quot;</span><span class="p">))</span>
</code></pre></figure>
<p>The <code>defhtml</code> macro can be used to implicitly generate HTML from its body, to avoid having to use the <code>html</code> macro for each individual element.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">defhtml</span> <span class="nv">page</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">body</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:html</span>
    <span class="p">[</span><span class="ss">:head</span>
      <span class="p">[</span><span class="ss">:title</span> <span class="s">&quot;Welcome&quot;</span><span class="p">]</span>
      <span class="p">[</span><span class="ss">:body</span> <span class="nv">body</span><span class="p">]]])</span>
</code></pre></figure>
<p>The <code>include-css</code> and <code>include-js</code> functions can be used to generate tags that include resources in an HTML head section, each accepting a variable number of resources.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">common</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">content</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">html5</span>
    <span class="p">[</span><span class="ss">:head</span>
      <span class="p">(</span><span class="nf">include-css</span> <span class="s">&quot;/css/mobile.css&quot;</span>
                   <span class="s">&quot;/some/path.css&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">include-js</span> <span class="s">&quot;/some/path.js&quot;</span>
                  <span class="s">&quot;/other/path.js&quot;</span><span class="p">)]</span>
    <span class="p">[</span><span class="ss">:body</span> <span class="nv">content</span><span class="p">]))</span>
</code></pre></figure><h2 id="enlive">
<span class="hash">#</span>
<a href="#enlive" class="header-link">Enlive</a>
</h2>
<p><a href="https://github.com/cgrand/enlive">Enlive</a> on the other hand implements a novel idea of performing transformations on pure HTML in order to generate dynamic content, instead of developing a language and embedding it within a template.</p>

<p>Enlive manages this by defining a template source, which consists of pure HTML. It then provides a variety of selectors to query and transform the HTML, much like jQuery.</p>

<p>Selectors are generally expressed as vectors. The <code>sniptest</code> function can be used to test selectors. The <code>content</code> is a function that transforms the content of the matched elements to the provided value.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">h/sniptest</span> <span class="s">&quot;&lt;h1&gt;Lorem Ipsum&lt;/h1&gt;&quot;</span>
  <span class="p">[</span><span class="ss">:h1</span><span class="p">]</span> <span class="p">(</span><span class="nf">h/content</span> <span class="s">&quot;Hello Reader!&quot;</span><span class="p">))</span>
</code></pre></figure>
<p>Selectors are usually crafted by just taking the CSS selector and prepending colons before every separate selector.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="c1">; CSS: div span.phone</span>
<span class="p">[</span><span class="ss">:div</span> <span class="ss">:span.phone</span><span class="p">]</span>
</code></pre></figure>
<p>The rule for nested vectors is that the outer-most vector denotes hierarchical chaining, and all others denote conjunction (AND). Disjunctions (OR) are supported by wrapping the selector within a set.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="c1">; chained selector</span>
<span class="c1">; CSS: div span.phone</span>
<span class="p">(</span><span class="nf">equivalent</span>
  <span class="p">[</span><span class="ss">:div</span> <span class="p">[</span><span class="ss">:span</span> <span class="ss">:.phone</span><span class="p">]]</span>
  <span class="p">[</span><span class="ss">:div</span> <span class="ss">:span.phone</span><span class="p">])</span>

<span class="c1">; conjunction</span>
<span class="c1">; CSS: div span.phone.mobile</span>
<span class="p">(</span><span class="nf">equivalent</span>
  <span class="p">[</span><span class="ss">:div</span> <span class="p">[</span><span class="ss">:span</span> <span class="p">[</span><span class="ss">:.phone</span> <span class="ss">:.mobile</span><span class="p">]]]</span>
  <span class="p">[</span><span class="ss">:div</span> <span class="ss">:span.phone.mobile</span><span class="p">])</span>

<span class="c1">; disjunction</span>
<span class="c1">; CSS: div#info span.phone, div#info span.email</span>
<span class="p">(</span><span class="nf">equivalent</span>
  <span class="o">#</span><span class="p">{[</span><span class="ss">:div#info</span> <span class="ss">:span.phone</span><span class="p">]</span> <span class="p">[</span><span class="ss">:div#info</span> <span class="ss">:span.email</span><span class="p">]}</span>
  <span class="p">[</span><span class="ss">:div#info</span> <span class="o">#</span><span class="p">{</span><span class="ss">:span.phone</span> <span class="ss">:span.email</span><span class="p">}]</span>
  <span class="p">[</span><span class="ss">:div#info</span> <span class="p">[</span><span class="ss">:span</span> <span class="o">#</span><span class="p">{</span><span class="ss">:.phone</span> <span class="ss">:.email</span><span class="p">}]]</span>
</code></pre></figure>
<p>There are predicates that can be used, such as <code>attr?</code>. Note that the nested vector is required to denote that the predicate is part of the <code>:a</code> selector, otherwise it would be interpreted as global <code>*</code>.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="c1">; CSS: a[class]</span>
<span class="p">[[</span><span class="ss">:a</span> <span class="p">(</span><span class="nf">attr?</span> <span class="ss">:class</span><span class="p">)]]</span>
</code></pre></figure>
<p>Creating a custom selector is as simple as leveraging the <code>pred</code> function, which takes a predicate on an element. The following is like <code>attr?</code> except that it checks to see if any attribute on the element matches the value.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">some-attr=</span>
  <span class="p">[</span><span class="nv">value</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">pred</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">node</span><span class="p">]</span> <span class="p">(</span><span class="nb">some </span><span class="o">#</span><span class="p">{</span><span class="nv">value</span><span class="p">}</span> <span class="p">(</span><span class="nb">vals </span><span class="p">(</span><span class="ss">:attrs</span> <span class="nv">node</span><span class="p">))))))</span>

<span class="p">(</span><span class="nf">sniptest</span> <span class="s">&quot;&lt;a one=\&quot;needle\&quot; two=\&quot;haystack\&quot;&gt;abc&lt;/a&gt;&quot;</span>
  <span class="p">[</span><span class="nv">some-attr=</span> <span class="s">&quot;needle&quot;</span><span class="p">]</span> <span class="p">(</span><span class="nf">set-attr</span> <span class="ss">:one</span> <span class="s">&quot;found&quot;</span><span class="p">))</span>
<span class="c1">;= &quot;&lt;a one=\&quot;found\&quot; two=\&quot;haystack\&quot;&gt;abc&lt;/a&gt;&quot;</span>
</code></pre></figure>
<p>Transformations can be a function of one element returning one element or a collection of elements or <code>nil</code>, or <code>nil</code> itself. As a result, conditions like <code>when</code> can be used as transformation functions, since they return <code>nil</code> is the condition is not met.</p>

<p>The <code>clone-for</code> function can be used to iterate and generate multiple elements.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">sniptest</span> <span class="s">&quot;&lt;ul&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&quot;</span>
  <span class="p">[</span><span class="ss">:li</span><span class="p">]</span> <span class="p">(</span><span class="nf">clone-for</span> <span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="mi">3</span> <span class="mi">0</span> <span class="mi">-1</span><span class="p">)]</span>
          <span class="nv">content</span> <span class="p">(</span><span class="nb">str </span><span class="nv">i</span><span class="p">)))</span>
<span class="c1">;= &quot;&lt;ul&gt;&lt;li&gt;3&lt;/li&gt;&lt;li&gt;2&lt;/li&gt;&lt;li&gt;1&lt;/li&gt;&lt;/ul&gt;&quot;</span>
</code></pre></figure>
<p>Sometimes the template source may contain attributes to make the selection process easier and/or faster. These attributes can be removed by using <code>do-&gt;</code>, which applies transformations in sequence.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">sniptest</span> <span class="s">&quot;&lt;ul&gt;&lt;li id=\&quot;foo\&quot;&gt;&lt;/li&gt;&lt;/ul&gt;&quot;</span>
  <span class="p">[</span><span class="ss">:#foo</span><span class="p">]</span> <span class="p">(</span><span class="nf">do-&gt;</span>
            <span class="p">(</span><span class="nf">remove-attr</span> <span class="ss">:id</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">clone-for</span> <span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="mi">3</span> <span class="mi">0</span> <span class="mi">-1</span><span class="p">)]</span>
              <span class="p">(</span><span class="nf">content</span> <span class="p">(</span><span class="nb">str </span><span class="nv">i</span><span class="p">)))))</span>
<span class="c1">;= &quot;&lt;ul&gt;&lt;li&gt;3&lt;/li&gt;&lt;li&gt;2&lt;/li&gt;&lt;li&gt;1&lt;/li&gt;&lt;/ul&gt;&quot;</span>
</code></pre></figure>
<p>The <code>defsnippet</code> form defines a function that loads HTML from a file that can be transformed. Snippets are the equivalent of partials in other frameworks. Its first argument is the name to give the function, the second is the path to the file relative to the classpath, and the third is the selector to treat as the root element---to which transformations are applied. It returns a sequence of maps representing the HTML elements. These can be added into regular templates using transformation functions like <code>append</code>.</p>

<p>A single HTML file may contain several snippets, each selecting its own relevant nodes.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">defsnippet</span> <span class="nv">footer</span> <span class="s">&quot;footer.html&quot;</span> <span class="p">[</span><span class="ss">:.footer</span><span class="p">]</span>
  <span class="p">[</span><span class="nv">message</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:.footer</span><span class="p">]</span> <span class="p">(</span><span class="nf">content</span> <span class="nv">message</span><span class="p">))</span>

<span class="p">(</span><span class="nf">footer</span> <span class="s">&quot;hello&quot;</span><span class="p">)</span>
<span class="c1">;= ({:tag :div, :attrs {:class &quot;footer&quot;}, :content (&quot;hello&quot;)}])</span>
</code></pre></figure>
<p>The <code>deftemplate</code> form works the same way, but a root cannot be specified. Instead of returning a sequence of maps like <code>defsnippet</code>, it returns a lazy sequence of strings containing HTML.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">deftemplate</span> <span class="nv">friends-list</span> <span class="s">&quot;friends.html&quot;</span>
  <span class="p">[</span><span class="nv">username</span> <span class="nv">friends</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:.username</span><span class="p">]</span> <span class="p">(</span><span class="nf">content</span> <span class="nv">username</span><span class="p">)</span>
  <span class="p">[</span><span class="ss">:ul.friends</span> <span class="ss">:li</span><span class="p">]</span> <span class="p">(</span><span class="nf">clone-for</span> <span class="p">[</span><span class="nv">f</span> <span class="nv">friends</span><span class="p">]</span>
                      <span class="p">(</span><span class="nf">content</span> <span class="nv">f</span><span class="p">)))</span>
</code></pre></figure><h1 id="databases">
<span class="hash">#</span>
<a href="#databases" class="header-link">Databases</a>
</h1>
<p>Being JVM-based, Clojure has access to the various Java database libraries such as JDBC, ORMs like Hibernate, and its own libraries like <a href="http://sqlkorma.com/">Korma</a>---which implements an EDSL for database interaction.</p>
<h2 id="jdbc">
<span class="hash">#</span>
<a href="#jdbc" class="header-link">JDBC</a>
</h2>
<p>The <span class="path">clojure.java.jdbc</span> namespace provides a thin layer between Clojure and <a href="http://en.wikipedia.org/wiki/Java_Database_Connectivity">JDBC</a>. A database &quot;spec&quot; is created that is essentially a map of configuration data to locate the JDBC driver and configure it and its connections. Alternatively, a JDBC data source instance can be used.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="c1">; example sqlite database spec</span>
<span class="p">(</span><span class="k">def </span><span class="nv">db-spec</span>
  <span class="p">{</span><span class="ss">:classname</span> <span class="s">&quot;org.sqlite.JDBC&quot;</span>
   <span class="ss">:subprotocol</span> <span class="s">&quot;sqlite&quot;</span>
   <span class="ss">:subname</span> <span class="s">&quot;test.db&quot;</span><span class="p">})</span>

<span class="p">(</span><span class="k">def </span><span class="nv">db-spec2</span>
  <span class="p">{</span><span class="ss">:datasource</span>
    <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">PGPoolingDataSource.</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.setServerName</span> <span class="s">&quot;localhost&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.setDatabaseName</span> <span class="s">&quot;maindb&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.setUser</span> <span class="s">&quot;user&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.setPassword</span> <span class="s">&quot;pass&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.setMaxConnections</span> <span class="mi">10</span><span class="p">))})</span>
</code></pre></figure>
<p>The <code>with-connection</code> function opens a connection to the database, and any expressions within its scope are executed within context of that connection. For example, <code>create-table</code> can be used within the scope to create a database table using either keywords or strings for the table and column names.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">jdbc/with-connection</span> <span class="nv">db-spec</span>
  <span class="p">(</span><span class="nf">jdbc/create-table</span> <span class="ss">:authors</span>
    <span class="p">[</span><span class="ss">:id</span> <span class="s">&quot;integer primary key&quot;</span><span class="p">]</span>
    <span class="p">[</span><span class="ss">:first_name</span> <span class="s">&quot;varchar&quot;</span><span class="p">]</span>
    <span class="p">[</span><span class="ss">:last_name</span> <span class="s">&quot;varchar&quot;</span><span class="p">]))</span>
</code></pre></figure>
<p>The <code>insert-record</code> function inserts a single record taken as a map. The <code>insert-records</code> function can insert a variable number of records into a database, yielding an equal number of corresponding indices for every inserted record. The <code>insert-rows</code> function can insert a variable number of rows given a vector of values corresponding to each column.</p>

<p>The <code>insert-values</code> function can be used to insert a partial record, which takes a vector of keywords representing the columns that will be inserted, and a vector of the respective values for those columns.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">jdbc/with-connection</span> <span class="nv">db-spec</span>
  <span class="p">(</span><span class="nf">jdbc/insert-records</span> <span class="ss">:authors</span>
    <span class="p">{</span><span class="ss">:first_name</span> <span class="s">&quot;Jackie&quot;</span> <span class="ss">:last_name</span> <span class="s">&quot;Chan&quot;</span><span class="p">}</span>
    <span class="p">{</span><span class="ss">:first_name</span> <span class="s">&quot;John&quot;</span> <span class="ss">:last_name</span> <span class="s">&quot;Doe&quot;</span><span class="p">}))</span>
<span class="c1">;= ({:last_insert_rowid() 1}</span>
<span class="c1">;=  {:last_insert_rowid() 2})</span>
</code></pre></figure>
<p>Records can be updated with <code>update-values</code> or <code>update-or-insert-values</code>, the latter inserts the row if it doesn&#39;t already exist.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">jdbc/with-connection</span> <span class="nv">db-spec</span>
  <span class="p">(</span><span class="nf">sql/update-values</span> <span class="ss">:users</span>
    <span class="p">[</span><span class="s">&quot;id=?&quot;</span> <span class="s">&quot;foo&quot;</span><span class="p">]</span> <span class="c1">; where id is &quot;foo&quot;</span>
    <span class="p">{</span><span class="ss">:pass</span> <span class="s">&quot;bar&quot;</span><span class="p">})</span> <span class="c1">; set pass to &quot;bar&quot;</span>
  
  <span class="p">(</span><span class="nf">sql/update-or-insert-values</span> <span class="ss">:users</span>
    <span class="p">[</span><span class="s">&quot;id=?&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
    <span class="p">{</span><span class="ss">:pass</span> <span class="s">&quot;bar&quot;</span><span class="p">}))</span>
</code></pre></figure>
<p>Records can be deleted using the <code>delete-rows</code> function:</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">jdbc/with-connection</span> <span class="nv">db-spec</span>
  <span class="p">(</span><span class="nf">sql/delete-rows</span> <span class="ss">:users</span> <span class="p">[</span><span class="s">&quot;id=?&quot;</span> <span class="s">&quot;foo&quot;</span><span class="p">]))</span>
</code></pre></figure>
<p>The <code>with-query-results</code> function can be used to fetch data, with the result being a lazy sequence which performs the fetching of data until it&#39;s actually necessary, so long as the source remains available. For this reason, it&#39;s common to use <code>doall</code> on the result to force the data to be fetched.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">jdbc/with-connection</span> <span class="nv">db-spec</span>
  <span class="p">(</span><span class="nf">jdbc/with-query-results</span> <span class="nv">res</span> <span class="p">[</span><span class="s">&quot;SELECT * FROM authors&quot;</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">doall </span><span class="nv">res</span><span class="p">))</span>
<span class="c1">;= ({:id 1, :first_name &quot;Jackie&quot;, :last_name &quot;Chan&quot;}</span>
<span class="c1">;=  {:id 2, :first_name &quot;John&quot;, :last_name &quot;Doe&quot;})</span>

  <span class="p">(</span><span class="nf">jdbc/with-query-results</span> <span class="nv">res</span> <span class="p">[</span><span class="s">&quot;SELECT * FROM authors WHERE id = ?&quot;</span> <span class="mi">2</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">doall </span><span class="nv">res</span><span class="p">)))</span>
<span class="c1">;= ({:id 2, :first_name &quot;John&quot;, :last_name &quot;Doe&quot;})</span>
</code></pre></figure>
<p>Transactions can be performed using the <code>transaction</code> form which performs its body within a transaction, aborting the transaction if an exception is thrown of a constraint is violated.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">jdbc/with-connection</span> <span class="nv">db-spec</span>
  <span class="p">(</span><span class="nf">jdbc/transaction</span>
    <span class="p">(</span><span class="nf">jdbc/delete-rows</span> <span class="ss">:authors</span> <span class="p">[</span><span class="s">&quot;id = ?&quot;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">Exception.</span> <span class="s">&quot;Abort transaction!&quot;</span><span class="p">))))</span>
<span class="c1">;= ; Exception Abort transaction!</span>
</code></pre></figure><h2 id="korma">
<span class="hash">#</span>
<a href="#korma" class="header-link">Korma</a>
</h2>
<p><a href="http://sqlkorma.com/">Korma</a> is a EDSL for relational databases, which handles generating SQL, connection pooling, and so on. The <code>defdb</code> form defines a connection for Korma to use, which does this by taking a database spec as with JDBC. The most recently defined database with <code>defdb</code> becomes the default connection for Korma for all queries unless otherwise specified. Korma also sets up a connection pool for the database.</p>

<p>Entities express to Korma the specifications of properties in database tables and the relationship between tables, similar to models in ActiveRecord.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">korma</span> <span class="nv">db</span> <span class="nv">core</span><span class="p">])</span>
<span class="p">(</span><span class="nf">defdb</span> <span class="nv">korma-db</span> <span class="nv">db-spec</span><span class="p">)</span>

<span class="p">(</span><span class="kd">declare </span><span class="nv">author</span><span class="p">)</span>

<span class="p">(</span><span class="nf">defentity</span> <span class="nv">country</span>
  <span class="p">(</span><span class="nf">pk</span> <span class="ss">:id</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">has-many</span> <span class="nv">author</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defentity</span> <span class="nv">author</span>
  <span class="p">(</span><span class="nf">pk</span> <span class="ss">:id</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">table</span> <span class="ss">:author</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">belongs-to</span> <span class="nv">country</span><span class="p">))</span>
</code></pre></figure>
<p>Queries can be performed using the <code>select</code> macro, which accepts a variety of functions used to build queries. The <code>with</code> function, for example, includes a relation in the result.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nb">select </span><span class="nv">author</span>
  <span class="p">(</span><span class="nf">with</span> <span class="nv">country</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">where</span> <span class="p">(</span><span class="nf">like</span> <span class="ss">:first_name</span> <span class="s">&quot;Ja%&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">order</span> <span class="ss">:last_name</span> <span class="ss">:asc</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">limit</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">offset</span> <span class="mi">1</span><span class="p">))</span>
</code></pre></figure>
<p>A query can be wrapped in the <code>sql-only</code> function to only generate the SQL, in order to, for example, print it out.</p>

<p>Korma represents queries as Clojure maps, allowing them to easily be manipulated by using the <code>select*</code> function to generate the map used to represent the query, instead of performing the query outright. Refining functions like <code>order</code>, <code>limit</code>, and <code>offset</code> take these maps as parameters to further modify the query. The <code>exec</code> function can ultimately be used to execute a query given one of these intermediary maps.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="k">def </span><span class="nv">query</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">select*</span> <span class="nv">author</span><span class="p">)</span>
             <span class="p">(</span><span class="nf">fields</span> <span class="ss">:last_name</span> <span class="ss">:first_name</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">last </span><span class="mi">5</span><span class="p">)))</span>
<span class="c1">;= {:group [],</span>
<span class="c1">;=  :from [{:table &quot;author&quot;,</span>
<span class="c1">;= ...</span>
</code></pre></figure>
<p>This can be used to great effect, such as performing multiple queries each with a different offset, used to paginate query results, for example.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="k">def </span><span class="nv">humans</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">select*</span> <span class="nv">humans</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">order</span> <span class="ss">:date_of_birth</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">kings-of-germany</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">humans</span>
                         <span class="p">(</span><span class="nf">where</span> <span class="p">{</span><span class="ss">:country</span> <span class="s">&quot;Germany&quot;</span>
                                 <span class="ss">:profession</span> <span class="s">&quot;King&quot;</span><span class="p">}))]</span>
  <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">start</span> <span class="p">(</span><span class="nb">range </span><span class="mi">0</span> <span class="mi">100</span> <span class="mi">10</span><span class="p">)</span>
          <span class="nv">k</span> <span class="p">(</span><span class="nb">select </span><span class="nv">kings-of-germany</span>
              <span class="p">(</span><span class="nf">offset</span> <span class="nv">start</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">limit</span> <span class="mi">10</span><span class="p">))]</span>
    <span class="c1">; process results</span>
    <span class="p">))</span>
</code></pre></figure><h1 id="clojurescript">
<span class="hash">#</span>
<a href="#clojurescript" class="header-link">ClojureScript</a>
</h1>
<p><a href="https://github.com/clojure/clojurescript/">ClojureScript</a> is a language that compiles to JavaScript. It allows for seamless interop with JavaScript using the same notation as Java interop in regular Clojure. Standard JavaScript functions are available in the <code>js</code> namespace.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">log</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">items</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">.log</span> <span class="nv">js/console</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">items</span><span class="p">)))</span>
</code></pre></figure>
<p>Properties are accessed using <code>.-</code> prefix notation. Properties can be set with the <code>set!</code> function, just as with Java interop.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">canvas</span> <span class="p">(</span><span class="nf">.getElementById</span> <span class="nv">js/document</span> <span class="s">&quot;canvas&quot;</span><span class="p">)</span>
      <span class="nv">width</span>  <span class="p">(</span><span class="nf">.-width</span> <span class="nv">canvas</span><span class="p">)</span>
      <span class="nv">height</span> <span class="p">(</span><span class="nf">.-height</span> <span class="nv">canvas</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;width: &quot;</span> <span class="nv">width</span>
       <span class="s">&quot;height: &quot;</span> <span class="nv">height</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">set!</span> <span class="p">(</span><span class="nf">.-width</span> <span class="nv">canvas</span><span class="p">)</span> <span class="mi">42</span><span class="p">))</span>
</code></pre></figure>
<p>Macros must be referenced with the <code>:require-macros</code> keyword in the namespace declaration. The macros must be defined in a <em>regular</em> Clojure file with a <span class="path">.clj</span> extension, and can have the same name for file and namespace as the file which references it.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">my.app</span>
  <span class="p">(</span><span class="ss">:require-macros</span> <span class="p">[</span><span class="nv">app.macros</span> <span class="ss">:as</span> <span class="nv">m</span><span class="p">]))</span>
</code></pre></figure>
<p>The <code>#js</code> tagged literal is for producing JavaScript objects and arrays, depending on the provided data structure. The literal is shallow, so that nesting JSON or arrays must also carry the <code>#js</code> literal tag.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="c1">; both produce the same JSON</span>
<span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:foo</span> <span class="s">&quot;bar&quot;</span><span class="p">}</span>
<span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="s">&quot;foo&quot;</span> <span class="s">&quot;bar&quot;</span><span class="p">}</span>

<span class="c1">; produces JavaScript array</span>
<span class="o">#</span><span class="nv">js</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]</span>

<span class="c1">; #js is shallow</span>
<span class="c1">; this object contains a persistent vector</span>
<span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:foo</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]}</span>

<span class="c1">; this object contains an array</span>
<span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:foo</span> <span class="o">#</span><span class="nv">js</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]}</span>
</code></pre></figure>
<p>The <code>js-&gt;clj</code> function can be used to convert JSON to a Clojure map. The option <code>:keywordize-keys</code> can be used to turn the keys into keywords.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cljmap</span> <span class="p">(</span><span class="nf">js-&gt;clj</span> <span class="ss">:keywordize-keys</span> <span class="nv">true</span><span class="p">)]</span>
  <span class="c1">;; whatever</span>
  <span class="p">)</span>
</code></pre></figure>
<p>The <code>..</code> Clojure macro can be used to chain multiple properties, for example.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="c1">; would access obj.prop.value.text</span>
<span class="p">(</span><span class="nb">.. </span><span class="nv">obj</span> <span class="nv">-prop</span> <span class="nv">-value</span> <span class="nv">-text</span><span class="p">)</span>
</code></pre></figure>
<p>Functions that need to be accessible from outside the ClojureScript must be &quot;exported&quot; to prevent the Google Closure compiler from changing the function name during the minification process.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="o">^</span><span class="ss">:export</span> <span class="nv">init</span> <span class="p">[]</span>
  <span class="p">(</span><span class="nf">something</span><span class="p">))</span>
</code></pre></figure>
<p>External libraries can also be affected by this. A separate file can contain functions and variables that should be ignored by the minification process. This file should then be specified in the configuration map.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="ss">:prod</span> <span class="p">{</span><span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src-cljs&quot;</span><span class="p">]</span>
       <span class="ss">:compiler</span>
         <span class="p">{</span><span class="ss">:optimizations</span> <span class="ss">:advanced</span>
          <span class="ss">:externs</span> <span class="p">[</span><span class="s">&quot;resources/externs.js&quot;</span><span class="p">]</span>
          <span class="ss">:output-to</span> <span class="s">&quot;output/file.js&quot;</span><span class="p">}}</span>
</code></pre></figure>
<p>The <a href="https://github.com/levand/domina">Domina</a> library is a ClojueScript interface to the DOM manipulation facilities of the Google Closure library. The <a href="https://github.com/JulianBirch/cljs-ajax">cljs-ajax</a> library can be used for AJAX calls.</p>
<h2 id="building">
<span class="hash">#</span>
<a href="#building" class="header-link">Building</a>
</h2>
<p>The <a href="https://github.com/emezeske/lein-cljsbuild">lein-cljsbuild</a> plug-in for lein can automate the compilation of ClojureScript by defining---in the <span class="path">project.clj</span> file---the namespaces to reference and the JavaScript files to output.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="ss">:cljsbuild</span>
  <span class="p">{</span><span class="ss">:builds</span>
    <span class="p">[{</span><span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src-cljs&quot;</span><span class="p">]</span>
      <span class="ss">:compiler</span>
        <span class="p">{</span><span class="ss">:pretty-print</span> <span class="nv">false</span>
         <span class="ss">:output-to</span> <span class="s">&quot;output/file.js&quot;</span><span class="p">}}]}</span>
</code></pre></figure>
<p>The <code>:builds</code> key can accept a map consisting of different application profiles to fine-tune the configuration based on the profile.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="ss">:cljsbuild</span>
  <span class="p">{</span><span class="ss">:builds</span>
    <span class="p">{</span><span class="ss">:dev</span> <span class="p">{</span><span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src-cljs&quot;</span><span class="p">]</span>
           <span class="ss">:compiler</span>
             <span class="p">{</span><span class="ss">:pretty-print</span> <span class="nv">true</span>
              <span class="ss">:output-to</span> <span class="s">&quot;output/file.js&quot;</span><span class="p">}}</span>
     <span class="ss">:prod</span> <span class="p">{</span><span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src-cljs&quot;</span><span class="p">]</span>
            <span class="ss">:compiler</span>
              <span class="p">{</span><span class="ss">:optimizations</span> <span class="ss">:advanced</span>
               <span class="ss">:output-to</span> <span class="s">&quot;output/file.js&quot;</span><span class="p">}}}}</span>
</code></pre></figure>
<p>When configured this way, the profile can be specified as the final argument to general <code>cljsbuild</code> commands to specify which profile to use.</p>

<p>With this configuration, it&#39;s possible to compile the specified ClojureScript files either one time, or automatically whenever the files are changed. Such commands are &quot;namespaced&quot; by the <code>cljsbuild</code> command. The <code>clean</code> command can clear previously generated files.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-bash"><span class="c"># one-off</span>
<span class="nv">$ </span>lein cljsbuild once

<span class="c"># automatically</span>
<span class="nv">$ </span>lein cljsbuild auto
</code></pre></figure><h1 id="om">
<span class="hash">#</span>
<a href="#om" class="header-link">Om</a>
</h1>
<p><a href="https://github.com/swannodette/om">Om</a> is a ClojureScript interface to <a href="/notes/react/">React</a> leveraging immutable data structures for increased speed. One thing to keep in mind is that Om uses an optimization that always renders on <code>requestAnimationFrame</code>, unlike React, and so the state has to be set even if it&#39;s not changed.</p>

<p>Application state in Om is held in an <code>atom</code>, which is the only reference type in ClojureScript. The application state can be transitioned with the <code>transact!</code> function which takes a transition function that shouldn&#39;t rely on information obtained by dereferencing a cursor, <code>get-state</code>, <code>transact!</code>, or <code>update!</code>. Changing the value via <code>swap!</code> or <code>reset!</code> always triggers a re-render of any roots attached to it. Everything in the atom must be an associative data structure, either map or an indexed sequence such as a vector. No lists or lazy sequences should be inside this state.</p>

<p>As in React, components take props, which in Om are actually <a href="/notes/clojure#zippers">cursors</a> into the application state. This is relevant because in Om, the entire application state is stored in an atom, but individual components generally don&#39;t care about the entire scope of the application data. Each component gets cursors at construction time and automatically re-render themselves when the value underneath the cursor changes.</p>

<p>During the render phase, cursors can be treated as their underlying value (e.g. map or vector), but outside of the render phase they need to explicitly be dereferenced to yield this underlying value.</p>

<p>It&#39;s possible to create sub-cursors <strong>only during the render phase</strong> using the <code>get</code> or <code>get-in</code> functions but if the underlying value is a primitive, then the primitive is returned and not a cursor.</p>

<p>The consequence of this is that it&#39;s not possible to create a component that depends on a single string, such as a text-input. A workaround for this would be to make the component depend on a <em>vector</em> of the single string.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="k">def </span><span class="nv">state</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:name</span> <span class="p">[</span><span class="s">&quot;Igor&quot;</span><span class="p">]}))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">text-input</span> <span class="p">[</span><span class="nv">cursor</span> <span class="nv">_</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">render</span> <span class="p">[</span><span class="nv">_</span><span class="p">]</span> <span class="p">(</span><span class="nf">dom/input</span> <span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:value</span> <span class="p">(</span><span class="nb">first </span><span class="nv">cursor</span><span class="p">)})))</span>

<span class="p">(</span><span class="nf">render</span> <span class="p">[</span><span class="nv">_</span><span class="p">]</span>
  <span class="c1">; yield sub-cursor to vector containing the string</span>
  <span class="p">(</span><span class="nf">om/build</span> <span class="nv">text-input</span> <span class="p">(</span><span class="ss">:name</span> <span class="nv">app-cursor</span><span class="p">)))</span>
</code></pre></figure>
<p>Cursors can propagate changes back to the original atom using the <code>transact!</code> function, which is available during and outside of the render phase. During the render phase, the <code>transact!</code>ed changes aren&#39;t visible until the next render. Outside of the render phase, <code>deref</code> returns the current value and <code>value</code> returns the last rendered value.</p>

<p>Components can depend on multiple cursors by simply wrapping them in a map or vector.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="k">def </span><span class="nv">state</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:courses</span> <span class="p">[</span><span class="nv">...</span><span class="p">]</span>, <span class="ss">:classes</span> <span class="p">[</span><span class="nv">...</span><span class="p">]</span>, <span class="nv">...</span><span class="p">}))</span>

<span class="p">(</span><span class="nf">render</span> <span class="p">[</span><span class="nv">_</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">om/build</span> <span class="nv">table-view</span> <span class="p">{</span><span class="ss">:rows</span> <span class="p">(</span><span class="ss">:courses</span> <span class="nv">state</span><span class="p">)</span>,
                        <span class="ss">:cols</span> <span class="p">(</span><span class="ss">:classes</span> <span class="nv">state</span><span class="p">)}))</span>
</code></pre></figure>
<p>The <code>root</code> function is used for mounting a component on a specific element in the DOM, like <code>React.renderComponent</code>. It takes a function that returns an Om component conforming to the <code>IRender</code> interface (like the <code>component</code> macro generates when the owner doesn&#39;t need to be accessed) given the application state and the backing React component, the application state atom, and a map containing the <code>:target</code> DOM node and any other options.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">om/root</span>
  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">app</span> <span class="nv">owner</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">om/component</span> <span class="p">(</span><span class="nf">dom/h1</span> <span class="nv">nil</span> <span class="p">(</span><span class="ss">:text</span> <span class="nv">app</span><span class="p">))))</span>
  <span class="nv">app-state</span>
  <span class="p">{</span><span class="ss">:target</span> <span class="p">(</span><span class="k">. </span><span class="nv">js/document</span> <span class="p">(</span><span class="nf">getElementById</span> <span class="s">&quot;app&quot;</span><span class="p">))})</span>
</code></pre></figure>
<p>DOM elements take the same attributes as in React: attributes and a body.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="k">def </span><span class="nv">app-state</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:list</span> <span class="p">[</span><span class="s">&quot;Lion&quot;</span> <span class="s">&quot;Zebra&quot;</span> <span class="s">&quot;Buffalo&quot;</span> <span class="s">&quot;Antelope&quot;</span><span class="p">]}))</span>

<span class="p">(</span><span class="nf">om/root</span>
  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">app</span> <span class="nv">owner</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">apply </span><span class="nv">dom/ul</span> <span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:className</span> <span class="s">&quot;animals&quot;</span><span class="p">}</span>
      <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">text</span><span class="p">]</span> <span class="p">(</span><span class="nf">dom/li</span> <span class="nv">nil</span> <span class="nv">text</span><span class="p">))</span> <span class="p">(</span><span class="ss">:list</span> <span class="nv">app</span><span class="p">))))</span>
  <span class="nv">app-state</span>
  <span class="p">{</span><span class="ss">:target</span> <span class="p">(</span><span class="k">. </span><span class="nv">js/document</span> <span class="p">(</span><span class="nf">getElementById</span> <span class="s">&quot;app&quot;</span><span class="p">))})</span>
</code></pre></figure>
<p>Om components have to be built using <code>build</code> for single components or <code>build-all</code>.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">contact-view</span> <span class="p">[</span><span class="nv">contact</span> <span class="nv">owner</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">reify</span>
    <span class="nv">om/IRender</span>
    <span class="p">(</span><span class="nf">render</span> <span class="p">[</span><span class="nv">this</span><span class="p">]</span>
      <span class="p">(</span><span class="nf">dom/li</span> <span class="nv">nil</span> <span class="p">(</span><span class="nf">display-name</span> <span class="nv">contact</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">contacts-view</span> <span class="p">[</span><span class="nv">app</span> <span class="nv">owner</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">reify</span>
    <span class="nv">om/IRender</span>
    <span class="p">(</span><span class="nf">render</span> <span class="p">[</span><span class="nv">this</span><span class="p">]</span>
      <span class="p">(</span><span class="nf">dom/div</span> <span class="nv">nil</span>
        <span class="p">(</span><span class="nf">dom/h2</span> <span class="nv">nil</span> <span class="s">&quot;Contact list&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">apply </span><span class="nv">dom/ul</span> <span class="nv">nil</span>
          <span class="p">(</span><span class="nf">om/build-all</span> <span class="nv">contact-view</span> <span class="p">(</span><span class="ss">:contacts</span> <span class="nv">app</span><span class="p">)))))))</span>
</code></pre></figure>
<p>Components can communicate using <span class="path">core.async</span> channels. To use this it is recommended to use <code>IRenderState</code> instead of <code>IRender</code>, so that state can be passed to it as the component state.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">contact-view</span> <span class="p">[</span><span class="nv">contact</span> <span class="nv">owner</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">reify</span>
    <span class="nv">om/IRenderState</span>
    <span class="p">(</span><span class="nf">render-state</span> <span class="p">[</span><span class="nv">this</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">delete</span><span class="p">]}]</span>
      <span class="p">(</span><span class="nf">dom/li</span> <span class="nv">nil</span>
        <span class="p">(</span><span class="nf">dom/span</span> <span class="nv">nil</span> <span class="p">(</span><span class="nf">display-name</span> <span class="nv">contact</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">dom/button</span>
          <span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:onClick</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">e</span><span class="p">]</span> <span class="p">(</span><span class="nf">put!</span> <span class="nv">delete</span> <span class="o">@</span><span class="nv">contact</span><span class="p">))}</span> <span class="s">&quot;Delete&quot;</span><span class="p">)))))</span>
</code></pre></figure>
<p>The encompassing component can implement <code>IInitState</code> in order to initialize the state, which in this case is simply a <span class="path">core.async</span> channel. This implements <code>IRenderState</code> as well so that it can receive the state and pass it on to its children.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">contacts-view</span> <span class="p">[</span><span class="nv">app</span> <span class="nv">owner</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">reify</span>
    <span class="nv">om/IInitState</span>
    <span class="p">(</span><span class="nf">init-state</span> <span class="p">[</span><span class="nv">_</span><span class="p">]</span>
      <span class="p">{</span><span class="ss">:delete</span> <span class="p">(</span><span class="nf">chan</span><span class="p">)})</span>

    <span class="nv">om/IRenderState</span>
    <span class="p">(</span><span class="nf">render-state</span> <span class="p">[</span><span class="nv">this</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">delete</span><span class="p">]}]</span>
      <span class="p">(</span><span class="nf">dom/div</span> <span class="nv">nil</span>
        <span class="p">(</span><span class="nf">dom/h2</span> <span class="nv">nil</span> <span class="s">&quot;Contact list&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">apply </span><span class="nv">dom/ul</span> <span class="nv">nil</span>
          <span class="p">(</span><span class="nf">om/build-all</span> <span class="nv">contact-view</span> <span class="p">(</span><span class="ss">:contacts</span> <span class="nv">app</span><span class="p">)</span>
            <span class="p">{</span><span class="ss">:init-state</span> <span class="p">{</span><span class="ss">:delete</span> <span class="nv">delete</span><span class="p">}}))))))</span>
</code></pre></figure>
<p>The protocol <code>IWillMount</code> is then implemented to establish a <code>go</code> loop that listens for events from the children contact views. The <code>get-state</code> function can be used to get a component&#39;s state. The <code>get-node</code> function can be used to get a reference to a component via a <code>ref</code>.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure">    <span class="nv">om/IWillMount</span>
    <span class="p">(</span><span class="nf">will-mount</span> <span class="p">[</span><span class="nv">_</span><span class="p">]</span>
      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">delete</span> <span class="p">(</span><span class="nf">om/get-state</span> <span class="nv">owner</span> <span class="ss">:delete</span><span class="p">)]</span>
        <span class="p">(</span><span class="nf">go</span> <span class="p">(</span><span class="k">loop </span><span class="p">[]</span>
          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">contact</span> <span class="p">(</span><span class="nf">&lt;!</span> <span class="nv">delete</span><span class="p">)]</span>
            <span class="p">(</span><span class="nf">om/transact!</span> <span class="nv">app</span> <span class="ss">:contacts</span>
              <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">xs</span><span class="p">]</span> <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">remove </span><span class="o">#</span><span class="p">(</span><span class="nb">= </span><span class="nv">contact</span> <span class="nv">%</span><span class="p">)</span> <span class="nv">xs</span><span class="p">))))</span>
            <span class="p">(</span><span class="nf">recur</span><span class="p">))))))</span>
</code></pre></figure><h1 id="deployment">
<span class="hash">#</span>
<a href="#deployment" class="header-link">Deployment</a>
</h1>
<p>Clojure web applications are generally packaged and deployed as servlets. Servlets are Java classes that extend the <span class="path">javax.servlet.http.HttpServlet</span> base class, which itself defines an interface for handling HTTP requests. Servlets can be deployed to one of many application servers. Application servers usually provide multitenancy, so that multiple applications can be deployed to the same application server. Most application servers are also web servers, but it&#39;s possible to proxy to a dedicated web server as well.</p>

<p>A Clojure web application using Ring, for example, can produce a servlet wrapper at runtime and hand that to the application server that runs embedded within the same process.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">ring.adapter.jetty</span> <span class="ss">:only</span> <span class="p">(</span><span class="nf">run-jetty</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">server</span> <span class="p">(</span><span class="nf">run-jetty</span> <span class="o">#</span><span class="ss">&#39;app</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">8080</span> <span class="ss">:join?</span> <span class="nv">false</span><span class="p">}))</span>
</code></pre></figure>
<p>It&#39;s also possible to deploy to a standalone application server, however, by packaging up the web application into a war file. The war files are a variation of jar files. They contain a <span class="path">web.xml</span> file that describes how the war file should be deployed, a <span class="path">lib/</span> directory containing the application&#39;s dependencies so as to make the war self-contained, and a <span class="path">classes/</span> directory containing the Clojure source files, JVM class files, and other assets.</p>

<p>The <span class="path">web.xml</span> file specifies the configuration for the deployment of the war file, including servlet mount points, behavior of user sessions, and app-server specific features.</p>

<p>Leiningen can build war files---as well as accompanying <span class="path">web.xml</span> files---using plug-ins such as <code>lein-ring</code>. This plugin requires a <code>:ring :handler</code> slot which specifies the namespace-qualified name of the top-level application request handler.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">defproject </span><span class="nv">com.some/project</span> <span class="s">&quot;1.0.0&quot;</span>
  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.4.0&quot;</span><span class="p">]</span>
                 <span class="p">[</span><span class="nv">compojure/compojure</span> <span class="s">&quot;1.0.1&quot;</span><span class="p">]</span>
                 <span class="p">[</span><span class="nv">ring/ring-servlet</span>   <span class="s">&quot;1.0.1&quot;</span><span class="p">]]</span>
  <span class="nv">plugins</span> <span class="p">[[</span><span class="nv">lein-ring</span> <span class="s">&quot;0.6.2&quot;</span><span class="p">]]</span>
  <span class="ss">:ring</span> <span class="p">{</span><span class="ss">:handler</span> <span class="nv">com.some.site/routes</span><span class="p">})</span>
</code></pre></figure>
<p>With this configuration, the war file could be created using the following command:</p>
<figure class="codeblock">
<pre>
<code class="highlight language-bash"><span class="nv">$ </span>lein ring uberwar
</code></pre></figure>
<p>Applications can be run locally for development and testing using Jetty with the following command. On each request, the Clojure source files are reloaded using the <code>require</code> function <sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup>.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-bash"><span class="nv">$ </span>lein ring server
</code></pre></figure><h2 id="http-kit">
<span class="hash">#</span>
<a href="#http-kit" class="header-link">HTTP Kit</a>
</h2>
<p><a href="http://http-kit.org/">HTTP kit</a> is a highly-concurrent HTTP server for Clojure. It&#39;s a near drop-in replacement for Jetty. A <code>main</code> method must be created that is accessible from Java, and the namespace that defines it must ensure that it is AOT compiled with the <code>:gen-class</code> key in the <code>ns</code> form. It&#39;s also necessary to define the entry-point in the <span class="path">project.clj</span> file.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">app.main</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="nv">app.handler</span>
        <span class="p">[</span><span class="nv">org.httpkit.server</span> <span class="ss">:only</span> <span class="p">[</span><span class="nv">run-server</span><span class="p">]])</span>
  <span class="p">(</span><span class="ss">:gen-class</span><span class="p">))</span> <span class="c1">; ensure this ns is compiled</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">port</span><span class="p">]]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">port</span> <span class="p">(</span><span class="k">if </span><span class="nv">port</span> <span class="p">(</span><span class="nf">Integer/parseInt</span> <span class="nv">port</span><span class="p">)</span> <span class="mi">3000</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">run-server</span> <span class="nv">app</span> <span class="p">{</span><span class="ss">:port</span> <span class="nv">port</span><span class="p">})</span>
    <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;You can view the site at http://localhost:&quot;</span> <span class="nv">port</span><span class="p">))))</span>
</code></pre></figure>
<p>Finally, an uberjar can be generated and the jar can be run like any other.</p>
<figure class="codeblock">
<pre>
<code class="highlight language-bash"><span class="nv">$ </span>lein uberjar
<span class="nv">$ </span>java -jar target/app-0.1.0-SNAPSHOT-standalone.jar
</code></pre></figure>
<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>This is an increasingly popular approach with other languages as well, such as Python and Flask, or Go and its variety of web development libraries.&nbsp;<a href="#fnref1" title="continue reading" rev="footnote"><i class="fa fa-level-up"></i></a></p></li>

<li id="fn2">
<p>This is similar to Play&#39;s development server.&nbsp;<a href="#fnref2" title="continue reading" rev="footnote"><i class="fa fa-level-up"></i></a></p></li>

</ol>
</div>
</div>
  <div class="meta">
    <div class="meta-component"><i class="fa fa-calendar fa-fw"></i> July  2, 2014</div>
    <div class="meta-component"><i class="fa fa-code-fork fa-fw"></i> <a href="https://github.com/blaenk/site/commits/master/input/notes/clojure-web-development.markdown">History</a><span class="hash">, <a href="https://github.com/blaenk/site/commit/dc6ff87" title="new table marker syntax; no need for metadata

This means there's no need to separate the toc marker from its
configuration, i.e. alignment. This never should've been necessary.

This has the nice side-effect of naturally invalidating the cache when
the toc marker is moved around or its alignment is changed.
">dc6ff87</a></span></div>
    <div class="meta-component"><i class="fa fa-pencil fa-fw"></i> <a href="..">Notes</a></div>
  </div>
</article>



    
    <footer id="footer">
  <div id="social">
    <a href="https://github.com/blaenk" title="github"><i class="fa fa-github-alt"></i></a>
    &middot;
    <a href="http://stackoverflow.com/users/101090/jorge-israel-pena" title="stackoverflow"><i class="fa fa-stack-overflow"></i></a>
    &middot;
    <a href="https://twitter.com/blaenk" title="twitter"><i class="fa fa-twitter"></i></a>
    &middot;
    <a href="mailto:jorge.israel.p@gmail.com" title="email"><i class="fa fa-envelope"></i></a>
    &middot;
    <a href="/rss.xml" title="feed"><i class="fa fa-rss-square"></i></a>
  </div>
  <!-- <div id="credit">
    Designed by <a href="http://www.blaenkdenum.com">Jorge Israel Peña</a>
  </div> -->
</footer>


<!-- this should instead be something like connectWS("{{{path}}}") -->


<script type="text/javascript">
  jQuery(function (){
    var ws = new WebSocket('ws://' + window.location.hostname + ':9160/notes/clojure-web-development.markdown');

    ws.onmessage = function (e) {
      var content = jQuery('article .entry-content');
      content.html(e.data);

      window.refresh();

      MathJax.Hub.Queue(["Typeset", MathJax.Hub, jQuery('article .entry-content')[0]]);

      if (window.jumpDown)
        window.scrollDown();
    };
  });
</script>




<!-- google analytics -->
<script async="true" type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37339861-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<!--MathJax CDN-->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    messageStyle: "none"
  });

  MathJax.Hub.Register.MessageHook('End Process', function() {
    jQuery('#MathJax_Font_Test').empty();
    jQuery('.MathJax_Display').parent().addClass('mathjax');
  });
</script>

  </div>
</body>
</html>
